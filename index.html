<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HÓA ĐƠN</title>
<style>
  body {
    font-family: Arial, sans-serif;
    width: 80mm; /* Khổ K80 */
    margin: 0 auto;
    padding: 0;
  }

  /* ===== Header ===== */
  .header {
    text-align: center;
    margin-bottom: 10px;
    border-bottom: 1px solid #000;
    padding-bottom: 6px;
  }
  .header img {
    max-width: 95px;
    display: block;
    margin: 0 auto 6px;
  }
  .header h1 {
    font-size: 18px;
    margin: 0;
    font-weight: bold;
    letter-spacing: 1px;
  }

  /* ===== Tiêu đề bill ===== */
  h2 {
    text-align: center;
    margin: 8px 0;
    font-size: 15px;
    font-weight: bold;
  }

  /* ===== Thông tin khách ===== */
  .info {
    margin-bottom: 8px;
  }
  .info p {
    margin: 2px 0;
    font-size: 12px;
    line-height: 1.3;
  }

  /* ===== Bảng món ăn ===== */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    margin-bottom: 8px;
  }
  thead th {
    border-bottom: 1px solid #000;
    font-weight: bold;
    padding: 4px 2px;
  }
  tbody td {
    padding: 4px 2px;
    border-bottom: 1px dashed #ccc;
  }
  td:nth-child(1) { width: auto; }
  td:nth-child(2) { text-align: center; width: 30px; }
  td:nth-child(3) { text-align: right; width: 60px; }

  /* ===== Tổng cộng ===== */
  .total {
    font-weight: bold;
    margin-top: 4px;
    font-size: 13px;
    border-top: 1px solid #000;
    padding-top: 4px;
  }

  /* ===== Lời cảm ơn ===== */
  .thank-you {
    text-align:center; 
    font-size:13px; 
    font-weight: bold;
    margin-top: 12px;
  }

  /* ===== QR Code ===== */
  .qrcode {
    text-align:center; 
    margin-top: 8px;
    padding-top: 4px;
  }
  .qrcode img {
    border: 1px solid #ccc;
    padding: 4px;
    border-radius: 6px;
    background: #fff;
  }

  @media print {
    body {
      margin: 0;
    }
  }
</style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <img src="https://i.postimg.cc/ZqqC4VNR/lacduong.jpg" alt="Logo Nhà Hàng">
    <h1>LẠC DƯƠNG QUÁN</h1>
  </div>

  <!-- Tiêu đề bill -->
  <h2>HÓA ĐƠN TÍNH TIỀN</h2>

  <!-- Thông tin khách -->
  <div class="info">
    <p><strong>Số phiếu:</strong> <span id="soPhieu"></span></p>
    <p><strong>Ngày:</strong> <span id="ngayTao"></span></p>
    <p><strong>Khách hàng:</strong> <span id="khachHang"></span></p>
  </div>

  <!-- Bảng món ăn -->
  <table>
    <thead>
      <tr>
        <th>Tên Món</th>
        <th>SL</th>
        <th>Thành tiền</th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>

  <!-- Tổng cộng -->
  <p class="total">Tổng cộng: <span id="tongCong">0</span></p>

  <!-- Lời cảm ơn -->
  <p class="thank-you">
    Xin cảm ơn, hẹn gặp lại quý khách!
  </p>

  <!-- QR Code -->
  <div class="qrcode">
    <img id="vietqr" alt="QR Thanh toán" width="120" height="120">
  </div>

<script>
  function formatCurrency(n){
    return new Intl.NumberFormat('vi-VN').format(n);
  }

  function getParam(name){
    const p = new URLSearchParams(window.location.search).get(name);
    return p ? decodeURIComponent(p) : '';
  }

  // Hàm hỗ trợ parse số: bỏ dấu chấm/dấu phẩy, ký tự khác
  function parseNumber(str){
    if (!str && str !== 0) return 0;
    // Loại bỏ mọi ký tự không phải số hoặc dấu trừ
    const clean = String(str).replace(/[^\d\-]/g, '');
    return parseInt(clean, 10) || 0;
  }

  // Thông tin cơ bản
  document.getElementById('soPhieu').textContent = getParam('soPhieu');
  document.getElementById('ngayTao').textContent = getParam('ngayTao');
  document.getElementById('khachHang').textContent = getParam('khachHang');

  const itemsRaw = getParam('items') || '';
  const rawParts = itemsRaw.split('|').map(s => s.trim()).filter(Boolean);

  const tbody = document.getElementById('itemsBody');
  let total = 0;

  rawParts.forEach(part => {
    const cols = part.split(',');
    if (cols.length >= 3) {
      // Lấy 2 trường cuối: theo bạn, trường cuối là "Thành tiền" (đã = SoLuong * DonGia)
      const priceStr = cols.pop().trim(); // thành tiền (đã tính sẵn)
      const qtyStr = cols.pop().trim();
      let name = cols.join(',').trim();
      name = name.replace(/^,|,$/g, "").trim();

      const qty = parseInt(qtyStr.replace(/[^\d\-]/g,''), 10) || 0;
      // *** SỬA: vì priceStr là 'Thành tiền' (đã = Soluong * Dongia),
      // không nhân thêm với qty nữa — dùng trực tiếp thành tiền.
      const amount = parseNumber(priceStr);

      if (name !== '' && qty > 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${name}</td>
          <td>${qty}</td>
          <td>${formatCurrency(amount)}</td>
        `;
        tbody.appendChild(tr);
        total += amount;
      }
    }
  });

  document.getElementById('tongCong').textContent = formatCurrency(total);

  // QR VietQR
  const bin = "970422"; // Mã ngân hàng Vietcombank
  const stk = "1018171392"; // Số tài khoản
  const ten = "TRAN VAN BAO"; // Tên chủ tài khoản
  const noiDung = "Thanh toan hoa don " + getParam('soPhieu');

  const qrUrl = `https://img.vietqr.io/image/${bin}-${stk}-compact2.png?amount=${total}&addInfo=${encodeURIComponent(noiDung)}&accountName=${encodeURIComponent(ten)}`;
  document.getElementById("vietqr").src = qrUrl;
</script>

</body>
</html>

